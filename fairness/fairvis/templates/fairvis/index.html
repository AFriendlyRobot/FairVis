{% load static %}

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<!-- <link rel="stylesheet" href="{% static 'fairvis/bootstrap.min.css' %}"> -->

<!-- <link rel="stylesheet" href="{% static 'fairvis/bootstrap-theme.min.css' %}"> -->

<link rel="stylesheet" href="{% static 'fairvis/style.css' %}" />
<link rel="stylesheet" href="{% static 'fairvis/tab.css' %}" />


<title>Fairness Visualization</title>

<h1 id="main-header" class="centered">Understanding Fairness in Data and ML</h1>


<div id="upload-container">
    <div id="data-upload-container">
        <form id="data-upload-form" action="{% url 'fairvis:upload_data' %}" method="post" enctype="multipart/form-data" class="upload-form">

            {% csrf_token %}

            <div class="form-group">
                <div class="input-group input-file" name="protedfileUpload">
                    <label for="protectedfile">Protected Attributes</label>
                    <input type="file" name="protectedfile" id="protectedfile" class="" />
                </div>
            </div>

            <div class="form-group">
                <div class="input-group input-file" name="datafileUpload">
                    <label for="datafile">Data CSV</label>
                    <input type="file" name="datafile" id="datafile" class="" />
                </div>
            </div>

            <div class="form-group">
                <div class="input-group input-file" name="predictfileUpload">
                    <label for="predictfile">Predictions</label>
                    <input type="file" name="predictfile" id="predictfile" class="" />
                </div>
            </div>

            <input type="submit" name="submit" value="Upload" id="dataSubmit" disabled="true" class="btn btn-primary"/>
        </form>
      </div>
</div> <!-- End upload forms -->

<!-- Tab links -->
<div id="viz-tabs" class="inactive">
  <div class="tab">
    <button id="definitions-tab" class="tablinks" onclick="openTab('definitions-tab', 'fairdef')">Fairness Definition</button>
    <button id="histogram-tab" class="tablinks" onclick="openTab('histogram-tab', 'histogram')">Histogram</button>
    <button id="calibration-tab" class="tablinks" onclick="openTab('calibration-tab', 'calibration')">Calibration</button>
  </div>
</div>

<!-- Tab content -->
<div id="fairdef" class="tabcontent">
  <h3>Fairness definitions</h3>
  <p><h4>Calibration :</h4></p>
  <p>(<a href="https://arxiv.org/pdf/1709.02012.pdf:">https://arxiv.org/pdf 1709.02012.pdf:</a>)</p>
  <p>&ldquo;When risk tools are used in practice, a key goal is that they are calibrated: if we look at the set of people who receive a predicted probability of p, we would like a p fraction of the members of this set to be positive instances of the classification problem [11]. Moreover, if we are concerned about fairness between two groups G1 and G2 (e.g. African-American defendants and white defendants) then we would like this calibration condition to hold simultaneously for the set of people within each of these groups as well [16]. Calibration is a crucial condition for risk tools in many settings. If a risk tool for evaluating defendants were not calibrated with respect to groups defined by race, for example, then a probability estimate of p could carry different meaning for African-American and white defendants, and hence the tool would have the unintended and highly undesirable consequence of incentivizing judges to take race into account when interpreting its predictions.</p>
  <p>Note that calibration in and of itself does not address protected attributes or differences between groups. However, it is often useful to evaluate a predictor's calibration within an individual group.&rdquo;</p>
  <p><h4>Statistical Parity:</h4></p>
  <p>&ldquo;Statistical parity is a common statistical notion of fairness which relies on prediction decisions but not true outcomes. If a predictor is operating on data with two distinct subpopulations to predict a binary outcome variable ("positive" or "negative"), it is said to exhibit statistical parity when the ratio of groups in the whole dataset is equal to the ratio of groups in the subset of data predicted to have a "positive" outcome&rdquo; [course notes]. Let&rsquo;s say we have for loan given by X and S is a subset of X with a protected feature such as race. Let D be the distribution on X. Classifier h : X-&gt;{-1,1} gives labels to X. &ldquo;When given a person x as input, h(x)=1 if x gets a loan and -1 otherwise. The bias, or statistical imparity, of h on S with respect to X,D is the following quantity. In words, it is the difference between the probability that a random individual drawn from Sis labeled 1 and the probability that a random individual from the complement S<sup>c</sup>is labeled 1.</p>
  <p style="text-indent: 5em;"><em>bias<sub>h</sub>(X,S,D) = Pr[h(x)=1|x &isin; S<sup>c</sup>] - Pr[h(x)=1|x &isin; S] </em></p>
  <p>&rdquo;(<a href="https://jeremykun.com/tag/statistics-2/">https://jeremykun.com/tag/statistics-2/</a>)</p>
  <p>Pr[h(x)=1|x belongs to S or Sc ] = FP+TP/Total (for each group)</p>
  <p>A predictor without bias satisfies statistical parity.</p>
  <p></p>
  <p><h4>Predictive Equality / Equal Opportunity :</h4></p>
  <p>(<a href="https://arxiv.org/pdf/1701.08230.pdf">https://arxiv.org/pdf/1701.08230.pdf</a>):</p>
  <p>&ldquo;Predictive equality means that the accuracy of decisions is equal across different . . . groups, as measured by false positive rate (FPR). For example, in the case of recividism prediction, this condition means that among defendants who would not have gone on to commit a violent crime if released, detention rates are equal across race groups. Formally, predictive equality means, E[d(X) | Y = 0, g(X)] = E[d(X) | Y = 0]</p>
  <p>E[d(X) | Y=0,g(X)] = FP/(FP+TN)&rdquo;</p>
  <p><h4>Error Rate Balance/Equal Odds:</h4></p>
  <p>Error rates between different groups are same i.e FPR of 2 groups is same and FNR of the 2 groups. FNR = FN/(FN+TP).</p>
  <p><h4>Predictive Parity:</h4></p>
  <p>Predictive parity states that given the predicted outcomes of a model and a certain threshold, the probability of the outcome being positive, given the ground truth above the threshold, should be the same across all groups of the population. Essentially, this refers to the true positive rate : TP/(TP+FP) which should be equal across all groups.</p>
  <p><h4>Conditional Statistical Parity:</h4></p>
  <p>The Conditional Statistical Parity introduces a condition on the Statistical Parity concept. This basically means that after a certain condition on one or more of the given protected attributes, if the predictor exhibits statistical parity, it fulfills the conditional statistical parity as well.</p>
</div>

<!-- Adaptation of histogram visualizations by Martin Wattenberg, Fernanda ViÃ©gas, and Moritz Hardt. Ref: https://research.google.com/bigpicture/attacking-discrimination-in-ml/ -->
<div id="histogram" class="tabcontent">
  <h3>2 Histograms</h3>
  <p style = "font-size: 16px;">
    Instructions: <br>
    1. Use the drop-down menus to select the desired protected field, values for group 1 and group 2 and the prediction model/scores. <br>
    2. Click the Visualize/Reset button. <br>
    3. Experiment with the definition buttons to explore different threshold settings. <br>
    4. Drag thresholds manually to investigate the statistics. <br>
    <br />
    X axis shows binned prediction score values<br/>
    Y axis shows counts of data points

  </p><br><br>
  <table> 
    <tr>
        <td rowspan=4 width=300 valign="top"> 
            <div id="histogram-buttons">
                Protected Field: <select id="protectedSelection" class="selectpicker"></select>
                <br><br>
                Group 1: <select id="group1Selection" class="selectpicker"></select>
                <br><br>
                Group 2: <select id="group2Selection" class="selectpicker"></select>
                <br><br>
                Model: <select id="modelSelection" class="selectpicker"></select>
                <br><br>
                <button id="start-hist-button" class="btn btn-primary visualize_histogram hist-btn" onclick="draw_histogram()">Visualize/Reset</button>

                <br><br>

                <button class="demo btn btn-default hist-btn" id="optimize-accuracy">Accuracy</button>
                <br />
                <br />
                <button class="demo btn btn-default hist-btn" id="optimize-equal-threshold">Equal Thresholds</button>
                <br />
                <br />
                <button class="demo btn btn-default hist-btn" id="optimize-statistical-parity">Statistical Parity</button>
                <br />
                <br />
                <button class="demo btn btn-default hist-btn" id="optimize-predictive-parity">Predictive Parity</button>
                <br />
                <br />
                <button class="demo btn btn-default hist-btn" id="optimize-equal-opportunity">Equal Opportunity</button>
                <br />
                <br />
                <button class="demo btn btn-default hist-btn" id="optimize-equal-odds">Equal Odds</button>


                <br>
            </div>
        </td>
    </tr>
    <tr>
      <td valign="top">
        <div class="big-label">Group 1<p id="left-group-acc-container"></p></div>
        <div id="histogram0"></div>
        <div id="histogram-legend0" class="histogram-legend"></div>
        <div id="histogram-stats0" class="histogram-stats"></div>
      </td>
      <td width=20>&nbsp;</td>
      <td valign="top">
        <div class="big-label">Group 2<p id="right-group-acc-container"></p></div>
        <div id="histogram1"></div>
        <div id="histogram-legend1" class="histogram-legend"></div>
        <div id="histogram-stats1" class="histogram-stats"></div>
      </td>
    </tr>
    <tr>
      <td>
        <div id="correct0"></div>
        <div id="pies0"></div>
      </td>
      <td width=20>&nbsp;</td>
      <td valign="top">
        <div id="correct1"></div>
        <div id="pies1"></div>
      </td>
    </tr>
  </table>
</div>

<div id="calibration" class="tabcontent">
    <h3>Evaluation of Calibration</h3>
    <p style = "font-size: 16px;">
    Instructions: 

    </p><br><br>
    <table id="calibration-controls-table">
        <tr>
            <td rowspan=4 width=300 valign="top">
                <div id="calibration-buttons">
                    Protected field: <select id="calibration-protected-selection" class="selectpicker"></select>

 <!--                    <br /><br />

                    Protected field value: <select id="calibration-class-value-selection" class="selectpicker"></select> -->

                    <br /><br />

                    Scoring Method: <select id="calibration-prediction-selection" class="selectpicker"></select>

                    <br /><br />

                    Number of bins: <input type="number" name="calibration-num-bins" id="calibration-num-bins" min="2" value="10" />

                    <br /><br />

                    <button class="btn btn-primary" id="visualize-calibration" onclick="draw_calibration()">Analyze calibration</button>
                </div>
            </td>
        </tr>

        <tr>
            <td valign="top">
                <div id="calibration-container"></div>
            </td>
        </tr>
    </table>

    <svg id="calibration-svg"></svg>
</div>





<!-- Ref: https://codepen.io/Sebus059/pen/MwMQbP?editors=1010 -->
<!-- <div class="form-group">
    <div class="input-group input-file" name="Fichier1">
        <span class="input-group-btn">
            <button class="btn btn-default btn-choose" type="button">Choose</button>
        </span>
        <input type="text" class="form-control" placeholder='Choose a file...' />
        <span class="input-group-btn">
             <button class="btn btn-warning btn-reset" type="button">Reset</button>
        </span>
    </div>
</div> -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script type="text/javascript" src="{% static 'fairvis/script.js' %}"></script>

<!-- D3 library -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="{% static 'd3/d3.v3.js' %}"></script>
<!-- <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script> -->

<!-- <script src="https://www.gstatic.com/external_hosted/d3/v4/d3.min.js"></script> -->


<!-- FOR WORK WHILE ON AMTRAK -->
<!-- <script type="text/javascript" src="{% static 'fairvis/jquery.min.js' %}"></script> -->
<!-- <script type="text/javascript" src="{% static 'fairvis/bootstrap.min.js' %}"></script> -->
<!-- <script type="text/javascript" src="{% static 'fairvis/d3.v3.min.js' %}"></script> -->
<!-- <script type="text/javascript" src="{% static 'fairvis/script.js' %}"></script> -->


<!-- <script src="https://d3js.org/d3.v3.js"></script> -->

<!-- js for plots and tabs --> 
<script src="{% static 'fairvis/viz_calibration.js' %}"></script>
<!-- <script src="{% static 'fairvis/viz_scatterplot.js' %}"></script> -->
<script src="{% static 'fairvis/viz_histogram.js' %}"></script>
<script src="{% static 'fairvis/tab.js' %}"></script>
